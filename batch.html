<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>批量查询志愿时长</title>
    <link rel="icon" href="volunteer.ico">
    <link rel="stylesheet" href="css/styles.css">
</head>
<body class="batch-page">
    <div class="container">
        <button class="back-btn" onclick="location.href='index.html'">← 返回普通查询</button>
        
        <h1>批量查询</h1>
        
        <div class="search-box">
            <textarea id="batchInput" placeholder="请输入查询内容，每行一个：&#10;格式示例：&#10;2022110001&#10;张三&#10;李四 2022110001"></textarea>
            <button onclick="doBatchSearch()" id="batchSearchBtn">批量查询</button>
        </div>
        
        <div id="errorMessage" class="error" style="display: none;"></div>
        <div id="successMessage" class="success" style="display: none;"></div>

        <div class="table-wrapper">
            <table id="resultsTable">
                <thead>
                    <tr>
                        <th>志愿者姓名</th>
                        <th>志愿者学号</th>
                        <th>个人总时长（小时）</th>
                        <th>详细信息</th>
                    </tr>
                </thead>
                <colgroup>
                    <col style="width:25%">
                    <col style="width:22%">
                    <col style="width:12%">
                    <col style="width:41%">
                </colgroup>
                <tbody id="resultsBody">
                    <tr>
                        <td colspan="4" style="text-align: center; color: #666; padding: 40px;">
                            请输入批量查询内容
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div class="total">
            <span>集体总时长：<span id="grandTotal">0</span> 小时</span>
            <button onclick="copySummaryResults()">复制统计结果</button>
            <button onclick="exportSummaryCSV()">导出统计结果为CSV</button>
            <button onclick="copyAllDetails()">复制详细结果</button>
            <button onclick="exportDetailsCSV()">导出详细结果为CSV</button>
        </div>
    </div>

    <!-- 引入脚本 -->
    <script src="js/config.js?v=20250915-1"></script>
    <script src="js/api.js?v=20250915-1"></script>

    <script>
        const SUMMARY_HEADERS = ['志愿者姓名', '志愿者学号', '个人总时长（小时）'];
        const DETAIL_HEADERS = [
            '志愿者姓名',
            '志愿者所在学院',
            '志愿者学号',
            '志愿服务时长',
            '志愿服务活动名称',
            '志愿服务学期',
            '志愿服务日期',
            '志愿服务区域',
            '志愿服务详细地址',
            '活动组织单位'
        ];

        let latestBatchResults = [];
        let latestGrandTotal = 0;
        const detailCache = new Map();

        // 页面初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 绑定Ctrl+Enter快速搜索
            document.getElementById('batchInput').addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.key === 'Enter') {
                    doBatchSearch();
                }
            });
        });

        // 执行批量搜索
        async function doBatchSearch() {
            const input = document.getElementById('batchInput').value.trim();
            
            if (!input) {
                utils.showError('请输入查询内容');
                return;
            }

            // 解析查询输入
            const queries = utils.parseBatchInput(input);
            
            if (queries.length === 0) {
                utils.showError('请输入有效的查询内容');
                return;
            }

            // 隐藏错误信息
            utils.hideError();
            
            // 显示加载状态
            const tbody = document.getElementById('resultsBody');
            tbody.innerHTML = '<tr><td colspan="4" class="loading">正在处理批量查询</td></tr>';
            document.getElementById('batchSearchBtn').disabled = true;

            latestBatchResults = [];
            latestGrandTotal = 0;
            detailCache.clear();

            try {
                const data = await volunteerAPI.batchSearch(queries);
                displayBatchResults(data);
            } catch (error) {
                utils.showError(error.message);
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #666;">查询失败</td></tr>';
                latestBatchResults = [];
                latestGrandTotal = 0;
            } finally {
                document.getElementById('batchSearchBtn').disabled = false;
            }
        }

        // 显示批量查询结果
        function displayBatchResults(data) {
            const tbody = document.getElementById('resultsBody');
            tbody.innerHTML = '';

            latestBatchResults = Array.isArray(data.results) ? data.results : [];
            latestGrandTotal = Number.isFinite(data.grand_total) ? data.grand_total : 0;

            if (latestBatchResults.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #666;">未找到任何记录</td></tr>';
                document.getElementById('grandTotal').textContent = '0';
                latestGrandTotal = 0;
                return;
            }

            latestBatchResults.forEach(result => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${result.name}</td>
                    <td>${result.student_id}</td>
                    <td>${result.total_duration.toFixed(1)}</td>
                    <td>
                        <button onclick="showDetails('${result.student_id}')" 
                                style="background: #007bff; color: white; padding:4px 8px; border:none; cursor:pointer; border-radius: 3px; font-size: 12px;">
                            查看详情
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            document.getElementById('grandTotal').textContent = latestGrandTotal.toFixed(1);
        }

        // 显示详细信息
        async function showDetails(studentId) {
            try {
                const data = await getStudentDetails(studentId);
                showDetailsModal(data);
            } catch (error) {
                utils.showError('获取详细信息失败: ' + error.message);
            }
        }

        async function getStudentDetails(studentId) {
            if (detailCache.has(studentId)) {
                return detailCache.get(studentId);
            }
            const data = await volunteerAPI.getDetails(studentId);
            detailCache.set(studentId, data);
            return data;
        }

        // 显示详情模态框
        function showDetailsModal(data) {
            // 创建模态框
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0,0,0,0.5);
                z-index: 1000;
                display: flex;
                justify-content: center;
                align-items: center;
            `;

            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: white;
                padding: 20px;
                border-radius: 8px;
                max-width: 90%;
                max-height: 80%;
                overflow: auto;
                position: relative;
            `;

            // 关闭按钮
            const closeBtn = document.createElement('button');
            closeBtn.textContent = '×';
            closeBtn.style.cssText = `
                position: fixed;      /* 改成 fixed */
                top: 60px;            /* 距离视口顶部 */
                right: 60px;          /* 距离视口右侧 */
                background: none;
                border: none;
                font-size: 48px;
                cursor: pointer;
                color: #FFF;
                z-index: 1100;        /* 确保在模态框之上 */
            `;
            closeBtn.onclick = () => document.body.removeChild(modal);

            // 详情表格
            const detailsTable = document.createElement('table');
            detailsTable.className = 'wrap-table details-table';
            
            let tableHTML = `
                <h3>${data.name} 的志愿服务详情</h3>
                <table class="wrap-table details-table" style="margin-top: 15px;">
                    <colgroup>
                        <col style="width:8%">  <!-- 姓名 -->
                        <col style="width:12%"> <!-- 学院 -->
                        <col style="width:9%">  <!-- 学号-->
                        <col style="width:9%">  <!-- 时长 -->
                        <col style="width:18%"> <!-- 活动名称-->
                        <col style="width:9%">  <!-- 学期 -->
                        <col style="width:9%">  <!-- 日期 -->
                        <col style="width:9%">  <!-- 区域 -->
                        <col style="width:12%"> <!-- 详细地址-->
                        <col style="width:9%">  <!-- 组织单位-->
                    </colgroup>
                    <thead>
                        <tr style="background-color: #f2f2f2;">
                            <th style="border: 1px solid #ddd; padding: 8px;">志愿者姓名</th>
                            <th style="border: 1px solid #ddd; padding: 8px;">志愿者所在学院</th>
                            <th style="border: 1px solid #ddd; padding: 8px;">志愿者学号</th>
                            <th style="border: 1px solid #ddd; padding: 8px;">志愿服务时长</th>
                            <th style="border: 1px solid #ddd; padding: 8px;">志愿服务活动名称</th>
                            <th style="border: 1px solid #ddd; padding: 8px;">志愿服务学期</th>
                            <th style="border: 1px solid #ddd; padding: 8px;">志愿服务日期</th>
                            <th style="border: 1px solid #ddd; padding: 8px;">志愿服务区域</th>
                            <th style="border: 1px solid #ddd; padding: 8px;">志愿服务详细地址</th>
                            <th style="border: 1px solid #ddd; padding: 8px;">活动组织单位</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            data.details.forEach(detail => {
                tableHTML += `
                    <tr>
                        <td style="border: 1px solid #ddd; padding: 8px;">${detail['志愿者姓名']}</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">${detail['志愿者所在学院']}</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">${detail['志愿者学号']}</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">${detail['志愿服务时长']}</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">${detail['志愿服务活动名称']}</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">${detail['志愿服务学期']}</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">${detail['志愿服务日期']}</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">${detail['志愿服务区域']}</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">${detail['志愿服务详细地址']}</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">${detail['活动组织单位']}</td>
                    </tr>
                `;
            });

            tableHTML += '</tbody></table>';

            modalContent.innerHTML = tableHTML;
            modalContent.appendChild(closeBtn);
            modal.appendChild(modalContent);
            document.body.appendChild(modal);

            // 点击背景关闭
            modal.onclick = (e) => {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            };
        }

        // 复制详细结果
        async function copyAllDetails() {
            const studentIds = getStudentIdsForDetails();
            if (studentIds.length === 0) {
                utils.showError('没有可复制的详细结果');
                return;
            }

            utils.showSuccess('正在准备详细数据，请稍候...');

            let allDetailsText = '志愿者姓名\t志愿者所在学院\t志愿者学号\t志愿服务时长\t志愿服务活动名称\t志愿服务学期\t志愿服务日期\t志愿服务区域\t志愿服务详细地址\t活动组织单位\n';
            
            try {
                for (const studentId of studentIds) {
                    const data = await getStudentDetails(studentId);
                    data.details.forEach(detail => {
                        allDetailsText += [
                            detail['志愿者姓名'],
                            detail['志愿者所在学院'],
                            detail['志愿者学号'],
                            detail['志愿服务时长'],
                            detail['志愿服务活动名称'],
                            detail['志愿服务学期'],
                            detail['志愿服务日期'],
                            detail['志愿服务区域'],
                            detail['志愿服务详细地址'],
                            detail['活动组织单位']
                        ].join('\t') + '\n';
                    });
                }

                const textarea = document.createElement('textarea');
                textarea.value = allDetailsText;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);

                utils.showSuccess('所有详细结果已复制到剪贴板！');
            } catch (error) {
                utils.showError('复制详细结果失败: ' + error.message);
            }
        }

        // 复制统计结果
        function copySummaryResults() {
            const table = document.getElementById('resultsTable');
            const tbody = document.getElementById('resultsBody');
            
            // 检查是否有数据
            if (tbody.children.length === 0 || 
                tbody.textContent.includes('请输入批量查询内容') || 
                tbody.textContent.includes('未找到任何记录')) {
                utils.showError('没有可复制的结果');
                return;
            }
            
            utils.copyToClipboard(table);
        }

        function getStudentIdsForDetails() {
            if (!latestBatchResults.length) {
                return [];
            }
            const uniqueIds = new Set(
                latestBatchResults
                    .map(item => item.student_id)
                    .filter(id => id !== undefined && id !== null && id !== '')
                    .map(id => String(id))
            );
            return Array.from(uniqueIds);
        }

        function exportSummaryCSV() {
            if (!latestBatchResults.length) {
                utils.showError('没有可导出的统计结果');
                return;
            }

            const rows = latestBatchResults.map(item => {
                const duration = typeof item.total_duration === 'number'
                    ? item.total_duration
                    : Number(item.total_duration) || 0;
                return [
                    item.name || '',
                    item.student_id || '',
                    duration.toFixed(1)
                ];
            });

            rows.push(['集体总时长', '', latestGrandTotal.toFixed(1)]);

            const filename = `批量查询统计结果_${utils.formatTimestampForFilename()}.csv`;
            utils.exportToCSV(filename, SUMMARY_HEADERS, rows);
        }

        async function exportDetailsCSV() {
            const studentIds = getStudentIdsForDetails();
            if (studentIds.length === 0) {
                utils.showError('没有可导出的详细结果');
                return;
            }

            const rows = [];

            try {
                for (const studentId of studentIds) {
                    const data = await getStudentDetails(studentId);
                    data.details.forEach(detail => {
                        rows.push(
                            DETAIL_HEADERS.map(header => detail[header] ?? '')
                        );
                    });
                }

                if (!rows.length) {
                    utils.showError('没有可导出的详细结果');
                    return;
                }

                const filename = `批量查询详细结果_${utils.formatTimestampForFilename()}.csv`;
                utils.exportToCSV(filename, DETAIL_HEADERS, rows);
            } catch (error) {
                utils.showError('导出详细结果失败: ' + error.message);
            }
        }
    </script>
</body>
</html>