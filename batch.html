<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>批量查询志愿时长</title>
    <link rel="icon" href="volunteer.ico">
    <link rel="stylesheet" href="css/styles.css">
</head>
<body class="batch-page">
    <div class="container">
        <button class="back-btn" onclick="location.href='index.html'">← 返回普通查询</button>
        
        <h1>批量查询</h1>
        
        <div class="search-box">
            <textarea id="batchInput" placeholder="请输入查询内容，每行一个：&#10;格式示例：&#10;2022110001&#10;张三&#10;李四 2022110001"></textarea>
            <button onclick="doBatchSearch()" id="batchSearchBtn">批量查询</button>
        </div>
        
        <div id="errorMessage" class="error" style="display: none;"></div>
        <div id="successMessage" class="success" style="display: none;"></div>

        <div class="table-wrapper">
            <table id="resultsTable">
                <thead>
                    <tr>
                        <th>志愿者姓名</th>
                        <th>志愿者学号</th>
                        <th>个人总时长（小时）</th>
                        <th>详细信息</th>
                    </tr>
                </thead>
                <colgroup>
                    <col style="width:25%">
                    <col style="width:22%">
                    <col style="width:12%">
                    <col style="width:41%">
                </colgroup>
                <tbody id="resultsBody">
                    <tr>
                        <td colspan="4" style="text-align: center; color: #666; padding: 40px;">
                            请输入批量查询内容
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div class="total">
            <span>集体总时长：<span id="grandTotal">0</span> 小时</span>
            <button onclick="copySummaryResults()">复制统计结果</button>
            <button onclick="exportSummaryToXLSX()">导出统计结果为xlsx</button>
            <button onclick="copyAllDetails()">复制详细结果</button>
            <button onclick="exportDetailsToXLSX()">导出详细结果为xlsx</button>
        </div>
    </div>

    <!-- 引入脚本 -->
    <script src="js/config.js?v=20250915-1"></script>
    <script src="js/api.js?v=20250915-1"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

    <script>
        // 页面初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 绑定Ctrl+Enter快速搜索
            document.getElementById('batchInput').addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.key === 'Enter') {
                    doBatchSearch();
                }
            });
        });

        const EXPORT_HEADERS = [
            '志愿者姓名',
            '志愿者所在学院',
            '志愿者学号',
            '志愿服务时长',
            '志愿服务活动名称',
            '志愿服务学期',
            '志愿服务日期',
            '志愿服务区域',
            '志愿服务详细地址',
            '活动组织单位'
        ];

        // 执行批量搜索
        async function doBatchSearch() {
            const input = document.getElementById('batchInput').value.trim();
            
            if (!input) {
                utils.showError('请输入查询内容');
                return;
            }

            const queries = utils.parseBatchInput(input);
            if (queries.length === 0) {
                utils.showError('请输入有效的查询内容');
                return;
            }

            utils.hideError();
            
            const tbody = document.getElementById('resultsBody');
            tbody.innerHTML = '<tr><td colspan="4" class="loading">正在处理批量查询</td></tr>';
            document.getElementById('batchSearchBtn').disabled = true;

            try {
                const data = await volunteerAPI.batchSearch(queries);
                window.latestBatchData = data; // 缓存结果
                displayBatchResults(data);
            } catch (error) {
                utils.showError(error.message);
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #666;">查询失败</td></tr>';
            } finally {
                document.getElementById('batchSearchBtn').disabled = false;
            }
        }

        // 显示批量查询结果
        function displayBatchResults(data) {
            const tbody = document.getElementById('resultsBody');
            tbody.innerHTML = '';

            if (!data.results || data.results.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #666;">未找到任何记录</td></tr>';
                document.getElementById('grandTotal').textContent = '0';
                return;
            }

            data.results.forEach(result => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${result.name}</td>
                    <td>${result.student_id}</td>
                    <td>${result.total_duration.toFixed(1)}</td>
                    <td>
                        <button onclick="showDetails('${result.student_id}')" 
                                style="background: #007bff; color: white; padding:4px 8px; border:none; cursor:pointer; border-radius: 3px; font-size: 12px;">
                            查看详情
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            document.getElementById('grandTotal').textContent = data.grand_total.toFixed(1);
        }

        // === 以下原有 showDetails / copyAllDetails 保持不变 ===
        async function showDetails(studentId) {
            try {
                const data = await volunteerAPI.getDetails(studentId);
                showDetailsModal(data);
            } catch (error) {
                utils.showError('获取详细信息失败: ' + error.message);
            }
        }

        function showDetailsModal(data) {
            const modal = document.createElement('div');
            modal.style.cssText = `position: fixed;top: 0;left: 0;width: 100%;height: 100%;background-color: rgba(0,0,0,0.5);z-index: 1000;display: flex;justify-content: center;align-items: center;`;
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `background: white;padding: 20px;border-radius: 8px;max-width: 90%;max-height: 80%;overflow: auto;position: relative;`;
            const closeBtn = document.createElement('button');
            closeBtn.textContent = '×';
            closeBtn.style.cssText = `position: fixed;top: 10%;right: 10%;background: none;border: none;font-size: 48px;cursor: pointer;color: #FFF;z-index: 1100;`;
            closeBtn.onclick = () => document.body.removeChild(modal);

            let tableHTML = `<h3>${data.name} 的志愿服务详情</h3><table class="wrap-table details-table" style="margin-top: 15px;">`;
            tableHTML += `<thead><tr><th>志愿者姓名</th><th>志愿者所在学院</th><th>志愿者学号</th><th>志愿服务时长</th><th>志愿服务活动名称</th><th>志愿服务学期</th><th>志愿服务日期</th><th>志愿服务区域</th><th>志愿服务详细地址</th><th>活动组织单位</th></tr></thead><tbody>`;
            data.details.forEach(detail => {
                tableHTML += `<tr><td>${detail['志愿者姓名']}</td><td>${detail['志愿者所在学院']}</td><td>${detail['志愿者学号']}</td><td>${detail['志愿服务时长']}</td><td>${detail['志愿服务活动名称']}</td><td>${detail['志愿服务学期']}</td><td>${detail['志愿服务日期']}</td><td>${detail['志愿服务区域']}</td><td>${detail['志愿服务详细地址']}</td><td>${detail['活动组织单位']}</td></tr>`;
            });
            tableHTML += '</tbody></table>';

            modalContent.innerHTML = tableHTML;
            modalContent.appendChild(closeBtn);
            modal.appendChild(modalContent);
            document.body.appendChild(modal);

            modal.onclick = (e) => { if (e.target === modal) document.body.removeChild(modal); };
        }

        async function copyAllDetails() {
            const tbody = document.getElementById('resultsBody');
            if (tbody.children.length === 0 || tbody.textContent.includes('请输入批量查询内容')) {
                utils.showError('没有可复制的详细结果');
                return;
            }
            const studentIds = Array.from(tbody.querySelectorAll('button[onclick^="showDetails"]'))
                                  .map(btn => btn.getAttribute('onclick').match(/'([^']+)'/)[1]);
            if (studentIds.length === 0) {
                utils.showError('没有可复制的详细结果');
                return;
            }

            utils.showSuccess('正在准备详细数据，请稍候...');
            let allDetailsText = '志愿者姓名\t志愿者所在学院\t志愿者学号\t志愿服务时长\t志愿服务活动名称\t志愿服务学期\t志愿服务日期\t志愿服务区域\t志愿服务详细地址\t活动组织单位\n';
            
            try {
                for (const studentId of studentIds) {
                    const data = await volunteerAPI.getDetails(studentId);
                    data.details.forEach(detail => {
                        allDetailsText += [
                            detail['志愿者姓名'],
                            detail['志愿者所在学院'],
                            detail['志愿者学号'],
                            detail['志愿服务时长'],
                            detail['志愿服务活动名称'],
                            detail['志愿服务学期'],
                            detail['志愿服务日期'],
                            detail['志愿服务区域'],
                            detail['志愿服务详细地址'],
                            detail['活动组织单位']
                        ].join('\t') + '\n';
                    });
                }

                const textarea = document.createElement('textarea');
                textarea.value = allDetailsText;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);

                utils.showSuccess('所有详细结果已复制到剪贴板！');
            } catch (error) {
                utils.showError('复制详细结果失败: ' + error.message);
            }
        }

        function copySummaryResults() {
            const table = document.getElementById('resultsTable');
            const tbody = document.getElementById('resultsBody');
            if (tbody.children.length === 0 || tbody.textContent.includes('请输入批量查询内容') || tbody.textContent.includes('未找到任何记录')) {
                utils.showError('没有可复制的结果');
                return;
            }
            utils.copyToClipboard(table);
        }

        // === 新增：导出统计结果为 XLSX ===
        async function exportSummaryToXLSX() {
            const tbody = document.getElementById('resultsBody');
            if (tbody.children.length === 0 || tbody.textContent.includes('请输入批量查询内容') || tbody.textContent.includes('未找到任何记录')) {
                utils.showError('没有可导出的结果');
                return;
            }

            if (!window.latestBatchData || !window.latestBatchData.results) {
                utils.showError('没有可导出的结果');
                return;
            }

            utils.showSuccess('正在准备统计数据，请稍候...');
            
            try {
                const summaryData = window.latestBatchData.results.map(result => ({
                    '志愿者姓名': result.name,
                    '志愿者学号': result.student_id, 
                    '个人总时长（小时）': result.total_duration.toFixed(1)
                }));

                // 添加集体总时长行
                summaryData.push({
                    '志愿者姓名': '集体总时长',
                    '志愿者学号': '',
                    '个人总时长（小时）': window.latestBatchData.grand_total.toFixed(1)
                });

                const ws = XLSX.utils.json_to_sheet(summaryData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "批量查询统计结果");
                
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
                XLSX.writeFile(wb, `批量查询统计结果_${timestamp}.xlsx`);

                utils.showSuccess('统计结果Excel文件已生成！');
            } catch (error) {
                utils.showError('导出失败: ' + error.message);
            }
        }

        // === 新增：导出详细结果为 XLSX ===
        async function exportDetailsToXLSX() {
            const tbody = document.getElementById('resultsBody');
            if (tbody.children.length === 0 || tbody.textContent.includes('请输入批量查询内容') || tbody.textContent.includes('未找到任何记录')) {
                utils.showError('没有可导出的结果');
                return;
            }

            const studentIds = Array.from(tbody.querySelectorAll('button[onclick^="showDetails"]'))
                                  .map(btn => btn.getAttribute('onclick').match(/'([^']+)'/)[1]);
            if (studentIds.length === 0) {
                utils.showError('没有可导出的结果');
                return;
            }

            utils.showSuccess('正在准备详细数据，请稍候...');
            let allDetails = [];

            try {
                for (const studentId of studentIds) {
                    const data = await volunteerAPI.getDetails(studentId);
                    allDetails = allDetails.concat(data.details);
                }

                const orderedDetails = allDetails.map(item => {
                    const orderedItem = {};
                    EXPORT_HEADERS.forEach(key => {
                        orderedItem[key] = item[key] ?? '';
                    });
                    return orderedItem;
                });

                const ws = XLSX.utils.json_to_sheet(orderedDetails, { header: EXPORT_HEADERS });
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "批量志愿服务记录");
                
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
                XLSX.writeFile(wb, `批量查询详细结果_${timestamp}.xlsx`);

                utils.showSuccess('详细结果Excel文件已生成！');
            } catch (error) {
                utils.showError('导出失败: ' + error.message);
            }
        }
    </script>
</body>
</html>